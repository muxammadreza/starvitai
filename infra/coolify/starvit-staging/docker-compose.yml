services:
  api:
    build:
      context: ../../..
      dockerfile: services/api/Dockerfile
    environment:
      STARVIT_MODE: live
      APP_ENV: staging
      
      # Auth & Config
      MEDPLUM_BASE_URL: ${MEDPLUM_BASE_URL:?MEDPLUM_BASE_URL is required}
      MEDPLUM_JWKS_URL: ${MEDPLUM_JWKS_URL}
      MEDPLUM_JWT_ISSUER: ${MEDPLUM_JWT_ISSUER:?MEDPLUM_JWT_ISSUER is required}
      MEDPLUM_JWT_AUDIENCE: ${MEDPLUM_JWT_AUDIENCE:?MEDPLUM_JWT_AUDIENCE is required}
      MEDPLUM_CLIENT_SECRET: ${MEDPLUM_CLIENT_SECRET} # Optional for startup, required for PHI writes
      
      # Backing Services (De-ID)
      GRAPH_STORE_URL: ${GRAPH_STORE_URL:?GRAPH_STORE_URL is required}
      GRAPH_STORE_TOKEN: ${GRAPH_STORE_TOKEN:?GRAPH_STORE_TOKEN is required}
      ANALYTICS_STORE_URL: ${ANALYTICS_STORE_URL:?ANALYTICS_STORE_URL is required}
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/health').read()\""]
      interval: 10s
      timeout: 5s
      retries: 3

  clinician:
    build:
      context: ../../..
      dockerfile: apps/clinician/Dockerfile
      # Note: Next.js PUBLIC vars are build-time. We must rebuild or use runtime config.
      # For staging, we assume a staging build or runtime overrides.
    environment:
      NEXT_PUBLIC_API_URL: https://api-staging.starvit.ca
      STARVIT_API_INTERNAL_URL: http://api:8000
    ports:
      - "3001:3000"

  research:
    build:
      context: ../../..
      dockerfile: apps/research/Dockerfile
    environment:
      NEXT_PUBLIC_API_URL: https://api-staging.starvit.ca
      STARVIT_API_INTERNAL_URL: http://api:8000
    ports:
      - "3002:3000"
